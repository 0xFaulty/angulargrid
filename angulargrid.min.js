/*
    angularGrid.js v 0.1.0
    Author: Sudhanshu Yadav
    Copyright (c) 2013 Sudhanshu Yadav - ignitersworld.com , released under the MIT license.
    Demo on: http://ignitersworld.com/lab/angulargrid/demo1.html
    Documentation and download on https://github.com/s-yadav/angulargrid 
*/

!function(t,n){function a(t){return t.complete&&("undefined"==typeof t.naturalWidth||0!==t.naturalWidth)}function e(t){return Array.prototype.slice.call(t)}var i={gridWidth:300,gutterSize:10,refreshOnImgLoad:!0},r=function(){var a=t.element(n);return function(t){return a[0]=t,a}}();t.element(document.head).append("<style>.no-transition{-webkit-transition: none !important;transition: none !important;}</style>"),t.module("angularGrid",[]).directive("angularGrid",["$timeout","$window","$q","angularGridInstance",function(n,o,d,l){return{restrict:"A",link:function(s,g,u){function h(){var t=z.offsetWidth;p=Math.floor(t/(y.gridWidth+y.gutterSize));var n=t%(y.gridWidth+y.gutterSize)+y.gutterSize;C=y.gridWidth+Math.floor(n/p),m.css({width:C+"px",height:"auto"}),I.length=0;for(var a=0;p>a;a++)I.push(0)}function c(){console.log("reflowed"),m.addClass("no-transition"),h(),e(m.find("img")).forEach(function(n){var a=t.element(n);if(a.hasClass("loaded"))return void a.css("height","");var e,i=a.attr("actual-width")||a.attr("data-actual-width"),r=a.attr("actual-height")||a.attr("data-actual-height");i&&r&&(e=n.width,d=r*e/i,a.css("height",d+"px"))});for(var n=[],a=0,i=m.length;i>a;a++){var o=m[a];n.push(o.offsetHeight)}m.removeClass("no-transition");for(var a=0,i=m.length;i>a;a++){var o=r(m[a]),d=n[a],l=Math.min.apply(Math,I),s=I.indexOf(l);I[s]=l+d+y.gutterSize;var u=s*(C+y.gutterSize);o.css({top:l+"px",left:u+"px"})}g.css("height",Math.max.apply(Math,I)+"px")}function f(){var i=!1;e(m).forEach(function(r){var o=t.element(r),l=o.find("img"),s=[];l.length&&(o.addClass("img-loading"),e(l).forEach(function(e){var r=t.element(e);a(e)?r.addClass("img-loaded"):s.push(d(function(t,a){r.addClass("img-loading"),e.onload=function(){!i&&y.refreshOnImgLoad&&(i=!0,n(function(){c(),i=!1},100)),r.removeClass("img-loading").addClass("img-loaded"),t()},e.onerror=a}))}),s.length?d.all(s).then(function(){o.removeClass("img-loading").addClass("img-loaded")},function(){o.removeClass("img-loading").addClass("img-loaded")}):o.removeClass("img-loading").addClass("img-loaded"))})}var m,v,p,C,g=g,z=g[0],w=t.element(o),W=u.angularGridId,S=u.angularGrid,I=(s.$eval(S),[]),y={gridWidth:u.gridWidth?parseInt(u.gridWidth):i.gridWidth,gutterSize:u.gutterSize?parseInt(u.gutterSize):i.gutterSize,refreshOnImgLoad:"false"==u.refreshOnImgLoad?!1:!0};s.$watch(S,function(){n(function(){m=g.children(),c(),f(),n(function(){g.addClass("angular-grid"),c()})})},!0),w.on("resize",function(){console.log("resized"),v&&n.cancel(v),v=n(function(){c()},100)}),W&&(l[W]={refresh:c})}}}]).factory("angularGridInstance",function(){var t={};return t})}(angular,window);